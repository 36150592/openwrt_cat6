<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<script type="text/javascript">
    $(document).ready(function(){
        TempUtil.render('tabsitems-template', 'tabsitems', networkconfightml.tab_menu);
        TempUtil.render('networkform1-template', 'form1', networkconfightml.form1);
        TempUtil.render('networkipMacEdit-template', 'ipMacEdit', networkconfightml.ipMacEdit);
        var showText = networkconfightml.prompt;

        var $lis = $("ul.tabs a");
        var $boxes = $("div.tab_boxes > div");
        var $btnSaveLan = $('#btnSaveLan');
        var $dhcp = $('tr.dhcp');
        var $chkDHCP = $('#dhcpServer');
        var ipMacs = [], firstRequest = true;

        var disableEdit = false;
        function createIpMacTable() {

            var length = ipMacs.length;
            var sb = new StringBuilder();

            sb.append(String.format('<table class="list" cellspacing="0"><tr><th>{0}</th><th>{1}</th><th>{2}</th><th>{3}</th><th>{4}</th></tr>',
                DOC.table.rowNo, DOC.net.mac, DOC.net.ip, DOC.table.edit, DOC.table.del));
            for (var i = 0; i < length; i++) {
                var item = ipMacs[i];
                sb.append(String.format('<tr><td>{0}</td>', i + 1));
                sb.append(String.format('<td id="mac{0}">{1}</td>', i, item.mac));
                sb.append(String.format('<td id="ip{0}">{1}</td>', i, item.ipaddr));
                sb.append(String.format('<td><a id="edit{0}" href="javascript:;">{1}</a></td>', i, disableEdit ? "" : showText.edit));
                sb.append(String.format('<td><a id="del{0}" href="javascript:;">{1}</a></td></tr>', i, disableEdit ? "" : showText.del));
            }
            sb.append('</table>');

            $('#ipBinds').html(sb.toString());

            $('a[id^=edit]').click(function() {
                if (disableEdit) return false;

                var id = this.id.substring(4);
                editIpMac(parseInt(id, 10), $('#mac' + id).text().trim(), $('#ip' + id).text().trim());
            });

            $('a[id^=del]').click(function() {
                if (disableEdit) return false;

                var id = this.id.substring(3);
                if (!confirm(String.format(showText.confirmDel, $('#mac' + id).text(), $('#ip' + id).text()))) {
                    return false;
                }
                ipMacs.splice(parseInt(id, 10), 1);
                createIpMacTable();
            });
        }

        $lis.click(function() {
            $lis.removeClass("current");
            $(this).addClass("current");
            var pannelIndex = $lis.index(this);
            $boxes.eq(pannelIndex).show().siblings().hide();
            $('#helper' + pannelIndex).show().siblings().hide();

            switch (pannelIndex) {
                case 0:
                    Page.postJSON({
                        json: { cmd: 102 },
                        success: function(datas) {
                             console.log(datas);
                            var data = datas.data;
                            var dstatus = data.status ? '1' : '0';
                            if (dstatus == DHCPServer.CLOSED) {
                                $chkDHCP.prop("checked", false);
                                $dhcp.hide();
                            } else {
                                $chkDHCP.prop("checked", true);
                                $dhcp.show();
                            }
                            $chkDHCP.attr('old',dstatus);

                            Page.setFormFieldValue2("lanIp", data.lanIp);
                            Page.setFormFieldValue2("netMask", data.netMask);
                            Page.setFormFieldValue2("ipBegin", data.ipBegin);
                            Page.setFormFieldValue2("ipEnd", data.ipEnd);
                            Page.setFormFieldValue2("expireTime", data.expireTime);
                            
                        }
                    });
                    Page.getHelperPage('html/config/networkConfig.html');
                    $('.helper_box').show();
                    break;
                case 1:
                    $('.helper_box').hide();
                    if (firstRequest) {
                        Page.postJSON({
                            json: {cmd: 103},
                            success: function (datas) {
                                console.log(datas);
                                ipMacs = datas.data;
                                createIpMacTable();
                                firstRequest = false;
                            }
                        });
                    }
                    break;

            }
        });

        $lis.eq(0).click();

        $chkDHCP.click(function() {
            if ($(this).prop("checked")) {
                $dhcp.show();
                //  $ipBegin.focus();
            } else {
                $dhcp.hide();
            }
        });

        var lan_rules = {
            lanIp : {required: true, gateway: true},
            netMask : {required: true, ip: true},
            ipBegin : {required: true, ipnozero: true},
            ipEnd : {required: true, ipnozero: true},
            expireTime : {required: true, digits: true, min: 1}
        };

        var lan_messages = {
            lanIp : {required: showText.ipCheckMsg1, gateway: showText.ipCheckMsg3},
            netMask : {required: showText.ipCheckMsg1, ip: showText.ipCheckMsg3},
            ipBegin : {required: showText.ipCheckMsg1, ip: showText.ipCheckMsg3},
            ipEnd : {required: showText.ipCheckMsg1, ip: showText.ipCheckMsg3},
            expireTime : {required: showText.timeCheckMsg1, digits: showText.timeCheckMsg2, min: showText.timeCheckMsg3}
        };

        $btnSaveLan.click(function(){
            $(this).attr("disabled",true);
            var count = 0;
            var $form = $('#form1');
            if(!CheckUtil.checkForm($form, lan_rules, lan_messages)){
                $(this).attr("disabled",false);
                return false;
            }
            var json = JSON.parmsToJSON($form);
            json.dhcpServer = json.dhcpServer ? '1' : '0';

            if(json.dhcpServer == DHCPServer.OPENED){
                if(!CheckUtil.checkNetSegment(json.lanIp, json.netMask, json.ipBegin)){
                    AlertUtil.alertMsg(showText.ipCheckMsg4);
                    $(this).attr("disabled",false);
                    return false;
                }
                if(!CheckUtil.checkNetSegment(json.lanIp, json.netMask, json.ipEnd)){
                    AlertUtil.alertMsg(showText.ipCheckMsg5);
                    $(this).attr("disabled",false);
                    return false;
                }
                if(json.ipBegin ==  $("#ipBegin").attr('old')  && json.ipEnd ==  $("#ipEnd").attr('old')){
                    delete json["ipBegin"];
                    delete json["ipEnd"];
                    count += 2;
                }else {
                    json.limitNum = json.ipEnd.replace(/\./g,'') - json.ipBegin.replace(/\./g,'') + 1;
                }
                if(json.expireTime ==  $("#expireTime").attr('old')){
                    delete json["expireTime"];
                    count++;
                }

            }else{
                delete json["ipBegin"];
                delete json["ipEnd"];
                delete json["expireTime"];
                count += 3;
            }

            if(json.dhcpServer == $("#dhcpServer").attr('old')){
                delete json["dhcpServer"];
                count++;
            }

            if(json.lanIp ==  $("#lanIp").attr('old')){
                delete json["lanIp"];
                count++;
            }
            if(json.netMask ==  $("#netMask").attr('old')){
                delete json["netMask"];
                count++;
            }

            if(count == 6){
                AlertUtil.alertMsg(CHECK.required.noChanges);
                $(this).attr("disabled",false);
                return false;
            }

            json.method = JSONMethod.POST;
            json.cmd = RequestCmd.NETWORK_CONFIG;

            /*if(json.lanIp ) {
                var isOk = false;
                var timeoutCtl = setTimeout(function() {
                    isOk = true;
                }, 1000 * 90);
                SysUtil.showProgress(ProgressTime.REBOOT, PROMPT.status.rebooting,
                    function() {
                        return isOk;
                    },
                    function() {
                        clearTimeout(timeoutCtl);
                        window.location.href = window.location.href.replace(window.location.host, json.lanIp);
                    }
                );
            }*/


            console.log(json);
            Page.postJSON({
                json: json,
                success: function(data) {
                   // AlertUtil.alertMsg(PROMPT.saving.success);
                    $lis.eq(0).click();
					if (AlertUtil.confirm(PROMPT.tips.rebootMessage)) {
                        reboot(json.lanIp);
                    }
                },
                complete: function(){
                    $('#btnSaveLan').attr("disabled",false);
                }
            });
            
        });
		
		function reboot(ip) {
            // 发送重启命令
            Page.postJSON({
                json: {
                    cmd: RequestCmd.SYS_REBOOT,
                    method: JSONMethod.POST
                },
                success: function() {	   
                    var isOk = false;
                    var timeoutCtl = setTimeout(function() {
                        isOk = true;
                    }, 1000 * 90);
                    SysUtil.showProgress(ProgressTime.REBOOT, PROMPT.status.rebooting,
                        function() {
                            return isOk;
                        },
                        function() {
                            clearTimeout(timeoutCtl);
                            if(ip){
                                window.location.href = window.location.href.replace(window.location.host, ip);
                            }else {
                                location.reload();
                            }

                        }
                    );
                },
                fail: function() {

                }
            });
        }

    });
</script>

<div class="detail_box">
    <div class="tab_menu">
        <ul class="tabs" id="tabsitems">
            <script type="text/template" id="tabsitems-template">
                <li><a href="javascript:;"><%- item1 %></a></li>
                <li><a href="javascript:;"><%- item2 %></a></li>
            </script>
        </ul>
    </div>
    <div class="tab_menu_bottom"></div>
    <div>
        <div class="tab_boxes">
            <div class="main_box">
                <form id="form1">
                    <script type="text/template" id="networkform1-template">
                        <table class="detail" cellspacing="0"><tr>
                            <th><%- th1 %></th>
                            <td><input type="text" id="lanIp" name="lanIp" class="normal inputs_lan"  /></td></tr>

                            <tr>
                                <th><%- th2 %></th>
                                <td><input type="text" id="netMask" name="netMask" class="normal inputs_lan"/></td></tr>

                            <tr class="nat">
                                <th><%- th3 %></th>
                                <td>
                                    <input type="checkbox" id="dhcpServer" name="dhcpServer" value="1" checked="checked" class="inputs_lan" /><%- td3 %>
                                </td>
                            </tr>
                            <tr class="nat dhcp">
                                <th><%- th4 %></th>
                                <td>
                                    <input type="text" id="ipBegin" name="ipBegin" class="txt4 inputs_lan"/> -
                                    <input type="text" id="ipEnd" name="ipEnd" class="txt4 inputs_lan"/></td></tr>
                            <tr class="nat dhcp">
                                <th><%- th5 %></th>
                                <td>
                                    <input type="text" id="expireTime" name="expireTime" class="txt2 inputs_lan"/>&nbsp;<%- td5 %></td>
                            </tr>
                            <tr id="trSaveLan">
                                <th>&nbsp;</th>
                                <td><input type="button" id="btnSaveLan" value="<%- btnSave %>"/></td>
                            </tr>
                        </table>
                    </script>
                </form>
            </div>
            <div id="ipMacEdit">
                <script type="text/template" id="networkipMacEdit-template">
                    <div id="ipBinds"><%- ipBinds %></div>
                    <div id="divBtns" style="margin-top:5px;">
                        <input id="btnAddIp" type="button" value="<%- btnAddIp %>" />
                        <input id="btnDeleteAll" type="button" value="<%- btnDeleteAll %>" />
                    </div>
                </script>
            </div>
        </div>
    </div>
    <div class="helper_box" style="display:none;">
        <div id="helper"></div>
    </div>
    <span style="clear:both"></span>
</div>