<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<script type="text/javascript">
    $(document).ready(function() {
        var currentId = Page.currentId;
        var count = 0;


        function getPinPukWarning(reqPin, reqPuk){
            if (reqPin == 1) {
                if (reqPuk == 1)
                    warning = PROMPT.tips.pinPukSet;
                else
                    warning = PROMPT.tips.pinSet;
            } else if (reqPuk == 1) {
                warning = PROMPT.tips.pukSet;
            } else {
                warning = "";
            }

            if (Page.isSimLocked && warning != "") {
                warning = PROMPT.tips.simLocked;
            }

            return warning;
        }


        //        function loop(){
//            if(currentId != Page.currentId) return;
//
//            if(count % 5 == 0)
//            {
//                loadPage();
//            }
//            if(count % 60 == 0)
//            {
//                    loadWlanPage();
//                    loadWlan5gPage();
//            }
//            count++;
//            setTimeout(loop, 10000000);
//        }

        function loop() {
            loadPage();
            loadWlanPage();
            loadWlan5gPage();
        }

        function getCardState(flag){
            var stateComment;
            if(flag == 0){
                stateComment = DOC.status.noSim;
            } else if(flag == 1) {
                stateComment = DOC.status.existSim;
            }

            return stateComment;
        }

        function getPINState(flag){
            var stateComment;
            if(flag == 0){
                stateComment = DOC.status.noreqPin;
            } else if(flag == 1) {
                stateComment = DOC.status.repPin;
            } else {
                stateComment = DOC.status.invalid;
            }

            return stateComment;
        }

        function getPUKState(flag){
            var stateComment;
            if(flag == 0){
                stateComment = DOC.status.noreqPuk;
            } else if(flag == 1) {
                stateComment = DOC.status.reqPuk;
            } else {
                stateComment = DOC.status.invalid;
            }

            return stateComment;
        }

        function getPinPukState(flag) {
            var pinState="",pukState="";
            if(flag == 0){
                pinState = DOC.status.noreqPin;
                pukState = DOC.status.noreqPuk;
            }else if(flag == 1){
                pinState = DOC.status.repPin;
                pukState = DOC.status.noreqPuk;
            }else if(flag == 2){
                pinState = DOC.status.noreqPin;
                pukState = DOC.status.reqPuk;
            }
            return { pinState: pinState, pukState: pukState };
        }
		
		function getNetState(flag) {
            var state = "?";
            if(flag == -1){
                state = "?";
            }else if(flag == 0){
                state = "2g";
            }else if(flag == 2){
                state = "3g";
            }else if(flag == 7){
                state = "4g";
            }
            return state;
        }
		
		 function getRegState(flag) {
           var csRegState ="", psRegState ="";
           switch(flag) {
               case 0:
                   csRegState = "无服务";
                   psRegState = "无服务";
                   break;
               case 1:
                   csRegState = "服务";
                   psRegState = "无服务";
                   break;
               case 2:
                   csRegState = "服务";
                   psRegState = "无服务";
                   break;
               case 3:
                   csRegState = "服务";
                   psRegState = "服务";
                   break;
               default:
                   csRegState = "未注册,并处于搜索状态";
                   psRegState = "未注册,并处于搜索状态";
                   break;
           }
            return { csRegState: csRegState, psRegState: psRegState };
        }
		
        function loadPage() {

            Page.postJSON({
                json: { cmd: RequestCmd.SYS_INFO },
                success: function(datas) {
                    var data =  {"success":true,"cmd":0,"uptime":" 16:00:35 up 1 day, 16:48,  load average: 0.53, 1.02, 0.75 ","connectStatus":"connect","wanIp":"","wanMaskIp":"",
                        "wanGateway":"","wanDNS":"","wanDNS_2":"","wanMac":"00:00:00:00:00:00","wanTxBytes":"0","wanRxBytes":"0","wanRxPackets":"0","wanTxPackets":"0",
                        "pinLock":"0","pukLock":0,"isSimExist":"","smsCount":"1,1,1,1","eregStat":"","regStat":"","gregStat":"","ps_cs":"","lanMac":"","lanIP":"","lanMaskIp":"","lanIPV6":"",
                        "wanIP":"","flux_month_total":"","wanIPV6":"","wanGateway_IPV6":"","wanDNS_3":"","wanDNS_4":"","enableWiFi":"false"};

                    var data2 = datas.data;
                    console.log(data2);
                    var data_system = data2.system;
                    var data_sim = data2.sim;
					var data_lan = data2.lan;
					var data_modem = data2.modem;


                    var names_run = [], names_lte = [], names_sim = [], names_net = [], names_lan = [], names_wan = [];
                    names_run.push(DOC.lbl.runtime);
                    names_run.push(DOC.lbl.loadAvg);
//                    names_run.push(run_text.currentSys);
                    names_run.push(DOC.lbl.memory);

                    names_sim.push(DOC.lbl.usim);
                    names_sim.push(DOC.lbl.pinCode);
                    names_sim.push(DOC.lbl.pukCode);

                    names_sim.push(DOC.lbl.simSms);
                    names_sim.push(DOC.lbl.terminalSms);

                    Page.isNULLToSpace = true;

                    var values_run = [], values_lte = [], values_sim = [], values_net = [], values_lan = [], values_wan = [];
                    /*
                     values.push(FormatUtil.formatField(data.name));
                     values.push(data.build);
                     values.push(FormatUtil.formatField(data.version));
                     values.push(FormatUtil.formatField(data.hwversion));
                     */
                    var runtime = ConvertUtil.timeStamp(data_system.runtime);
                    values_run.push(runtime);
                    values_run.push(data_system.cpu_average1 + ", " + data_system.cpu_average5 + ", " + data_system.cpu_average15);
					values_run.push(data_system.mem_total + "KB");

//                    var currentSys = data.currentSys, currentSysText = '';
//                    if (currentSys == '1') {
                    //                       currentSysText = run_text.viceSys;
                    //                   } else {
                    //                       currentSysText = run_text.mainSys;
//                    }
//                    values_run.push(currentSysText);
//                    values_run.push(data.memory);


//                    var pinLock = parseInt(data.pinLock, 10);
//                    var pukLock = parseInt(data.pukLock, 10);
//                    // var pinTime = parseInt(data.pinTime, 10);
//                    var pinState = getPINState(pinLock);
//                    var pukState = getPUKState(pukLock);
//                    var warning = getPinPukWarning( pinLock, pukLock);
//                    var moduleType = data.moduleType;
//
//                    var warningTime = getAutomaticWarning(pinTime);
//                    var warningTime2 = getModuleWarning(moduleType);
                    var stateInfo = "";
//                    if(pinLock == 1){
//                        if (warning != "") {
//                            stateInfo = String.format('<span style="color:red;"> &nbsp;{0}</span>', warning);
//                        }
//                    }
                    var pinPukStateInfo = getPinPukState(data_sim.card_status);
                    values_sim.push(getCardState(data_sim.is_sim_exist));
                    values_sim.push(pinPukStateInfo.pinState);
                    values_sim.push(pinPukStateInfo.pukState);

                    //  if (supportSMS && !Page.isModulP500() && !Page.isModulMC2716() && !Page.isModuleC5300V() && !Page.isModulLT10()) {
                    var smsCount = data.smsCount || "0,0,0,0" ;
                    if(!(/\d+\,\d+\,\d+\,\d+/.test(smsCount))){
                        smsCount = "0,0,0,0";
                    }
                    var smsCounts = smsCount.split(',');
                    values_sim.push(String.format("{0}/{1}", smsCounts[0], smsCounts[1]));
                    values_sim.push(String.format("{0}/{1}", smsCounts[2], smsCounts[3]));
                    //  }

                    var dialMode = data.dialMode;
                    var connectStatus = data.connectStatus;

                    names_net.push(DOC.lbl.dialMode);
                    names_net.push(DOC.lbl.dialState);

                    if(dialMode == DialMode.MANUALLY){
                        values_net.push(DOC.lbl.manualDial);
                    } else {
                        values_net.push(DOC.lbl.autoDial);
                    }

                    if(connectStatus == ConnectStatus.CONNECT){
                        values_net.push(String.format(DOC.status.connected));
                    } else {
                        values_net.push(String.format(DOC.status.disconnected));
                    }

                    names_net.push(DOC.lbl.netMode);
                    names_net.push(DOC.lbl.signal);
                    names_net.push(DOC.lbl.signalLevel);
                    names_net.push(DOC.lbl.plmn);
                    names_net.push(DOC.lbl.regState);
                    names_net.push(DOC.lbl.psReg);
                    names_net.push(DOC.lbl.epsReg);

                    //var netState = StatusUtil.getNetState(data.signalLevel, data.eregStat, data.act, 0);
					var netState = getNetState(data_modem.act);
					var singalLevel = data_modem.signal_lvl;
                    
                    // 网络都注册失败时显示未知
                   // if (!StatusUtil.isAnyRegSuccess(data.regStat, data.gregStat, data.eregStat)) {
                      //  netState = "?";
                      //  singalLevel = 0;
                   // }
                    values_net.push(netState);
                    values_net.push(StatusUtil.formatSingalLevel(singalLevel));
                    values_net.push(FormatUtil.formatField(data_modem.rsrp));

                    var plmn = FormatUtil.formatField(data_modem.plmn);
                    values_net.push(FormatUtil.formatPLMN(plmn));
					
					var ps_cs = parseInt(data.ps_cs, 10);
                    var regState = getRegState(ps_cs);
					values_net.push(regState.csRegState);
                    values_net.push(regState.psRegState);
                    values_net.push(netState == "3G" ? DOC.status.noreg : StatusUtil.getRegState(data.eregStat));

                    names_lan.push(DOC.net.mac);
                    names_lan.push(DOC.net.ip);
                    names_lan.push(DOC.net.mask);

                    values_lan.push(FormatUtil.formatField(data.lanMac));

                    Page.lanIp = FormatUtil.formatField(data_lan.lanIp);
                    values_lan.push(Page.lanIp);
                    values_lan.push(FormatUtil.formatField(data_lan.netMask));
                    var lanIPV6 = FormatUtil.formatField(data.lanIPV6);
                    if(lanIPV6 != ""){
                        names_lan.push(DOC.net.ipv6);
                        values_lan.push(lanIPV6);
                    }
                    names_lan.push(DOC.net.dhcpServer);
                    var dhcp = data_lan.status ? '1' : '0';
                    if(dhcp == DHCPServer.CLOSED){
                        values_lan.push(DOC.status.closed);
                    } else {
                        values_lan.push(DOC.status.opened);
                    }

                    names_wan.push(DOC.net.mac);
                    names_wan.push(DOC.net.ip);
                    names_wan.push(DOC.net.mask);
                    names_wan.push(DOC.net.gateway);
                    names_wan.push(DOC.net.dns1);
                    names_wan.push(DOC.net.dns2);

                    if(connectStatus == ConnectStatus.CONNECT){
                        values_wan.push(FormatUtil.formatField(data.wanMac));
                        values_wan.push(FormatUtil.formatField(data.wanIP));
                        values_wan.push(FormatUtil.formatField(data.wanMaskIp));
                        values_wan.push(FormatUtil.formatField(data.wanGateway));
                        if(FormatUtil.formatField(data.wanIP) == ''){
                            values_wan.push(FormatUtil.formatField("NULL"));
                            values_wan.push(FormatUtil.formatField("NULL"));
                        } else {
                            values_wan.push(FormatUtil.formatField(data.wanDNS));
                            values_wan.push(FormatUtil.formatField(data.wanDNS_2));
                        }
                    } else {
                        values_wan.push('');
                        values_wan.push('');
                        values_wan.push('');
                        values_wan.push('');
                        values_wan.push('');
                        values_wan.push('');
                    }

                    if(FormatUtil.formatField(data.wanIPV6) != ''){
                        names_wan.push(DOC.net.ipv6);
                        names_wan.push(DOC.net.gatewayv6);
                        names_wan.push(DOC.net.dns3);
                        names_wan.push(DOC.net.dns4);

                        if(connectStatus == ConnectStatus.CONNECT){
                            values_wan.push(FormatUtil.formatField(data.wanIPV6));
                            values_wan.push(FormatUtil.formatField(data.wanGateway_IPV6));
                            values_wan.push(FormatUtil.formatField(data.wanDNS_3));
                            values_wan.push(FormatUtil.formatField(data.wanDNS_4));
                        } else {
                            values_wan.push('');
                            values_wan.push('');
                            values_wan.push('');
                            values_wan.push('');
                        }
                    }
                    names_wan.push(DOC.net.rxPackets);
                    names_wan.push(DOC.net.rxBytes);
                    names_wan.push(DOC.net.txPackets);
                    names_wan.push(DOC.net.txBytes);
                    // names_wan.push(wan_text.manageTime);

                    values_wan.push(FormatUtil.formatField(data.wanRxPackets));
                    values_wan.push(FormatUtil.formatField(data.wanRxBytes));
                    values_wan.push(FormatUtil.formatField(data.wanTxPackets));
                    values_wan.push(FormatUtil.formatField(data.wanTxBytes));
                    // var manageTime = parseInt(data.manageTime.trim());
                    // var theUptime = parseInt(data.theUptime.trim());
                    // if (!isNaN(manageTime) && !isNaN(theUptime)) {
                    // 	var millseconds = new Date().getTime() - (theUptime - manageTime) * 1000;
                    // 	var manageDate = new Date(millseconds);
                    // 	values_wan.push(manageDate.format("yyyy-mm-dd HH:MM:ss"));
                    // } else {
                    // 	values_wan.push(data.manageTime);
                    // }
                    //  var  warningsss = getWanState(data.showMode);

                    //if (warningsss != ""){
                    //  var stateWan = String.format('<span style="color:black;"> &nbsp;{0}</span>', warningsss);
                    var run_html = Page.createTable(DOC.title.run, names_run, values_run, names_run.length, 2).replace("<td>", "<td style=\"width:32%;\">");
                    var sim_html = Page.createTable(DOC.title.sim + stateInfo, names_sim, values_sim, names_sim.length, 2).replace("<td>", "<td style=\"width:32%;\">");
                    var net_html = Page.createTable(DOC.title.network, names_net, values_net, names_net.length, 2).replace("<td>", "<td style=\"width:32%;\">");
                    var wan_html = Page.createTable(DOC.title.wan, names_wan, values_wan, names_wan.length, 2).replace("<td>", "<td style=\"width:32%;\">");
                    var lan_html = Page.createTable(DOC.title.lan, names_lan, values_lan, names_lan.length, 2).replace("<td>", "<td style=\"width:32%;\">");


                    $('#run_info').html(run_html);
                    $('#net_info').html(net_html);
                    $('#sim_info').html(sim_html);
                    $('#wan_info').html(wan_html);
                    $('#lan_info').html(lan_html);

                    //        Page.setStripeTable();
                    Page.isNULLToSpace = false;
                }
            });


        }

        function getWlanSecMode(encKey, wpa, wpaKeyMgmt, wpaPairwise)
        {
            var secMode;

            if(encKey == "on")
            {
                if(wpaKeyMgmt == "WPA-PSK")
                {

                    if(wpaPairwise == "CCMP")
                        wpaPairwise = "AES";

                    if(wpa == "3")
                        secMode = "WPA-PSK/WPA2-PSK" + "[" + wpaPairwise + "]";
                    else if(wpa == "2")
                        secMode = "WPA2-PSK" + "[" + wpaPairwise + "]";
                    else if(wpa == "1")
                        secMode = "WPA-PSK" + "[" + wpaPairwise + "]";
                    else
                        secMode = "None";
                }
                else
                    secMode = "None";
            }
            else
            {
                secMode = "None";
            }

            return secMode;
        }

        function loadWlanPage() {
		Page.postJSON({
                json: {cmd: 101},
                success: function (datas) {
            var data = {"mode":"Master","accessPoint":"","essid":"","wirelessMac":"","ssidBroadcast":"","encKey":"","wpa":"","wpaKeyMgmt":"","wpaPairwise":"","frequency":"","txPower":""};
            data.message ="WLAN未开启";
            var wirelessHtml = "";
            if (data.mode.trim() == "NULL") {
                wirelessHtml = Page.createTable(DOC.title.wlan2g + '-' + data.message, [], [], 0, 0);
            } else {
                var names = [];
                var values = [];
                var data2 = datas.data;
                names.push(DOC.wlan.currentMode);
                values.push(DOC.wlan.ApMode);

                names.push(DOC.wlan.wifi);
                if(data2.status == "0"){
                      values.push(DOC.status.opened);
                } else {
                      values.push(DOC.status.closed);
                }

                names.push(DOC.wlan.ssid);
                values.push(FormatUtil.formatField(data2.ssid));

                names.push(DOC.net.mac);
                values.push(FormatUtil.formatField(data.wirelessMac));

                names.push(DOC.wlan.ssidBroadcast);
                if(data2.hidden == "1"){
                    values.push(DOC.status.opened);
                } else {
                    values.push(DOC.status.closed);
                }

                names.push(DOC.wlan.secMode);
				if(data2.encryption == "none"){
                            values.push("无");
                        }else {
                            values.push("WPA2PSK[AES]");
                }
                //values.push(FormatUtil.formatField(getWlanSecMode(data.encKey.trim(), data.wpa.trim(), data.wpaKeyMgmt.trim(), data.wpaPairwise.trim())));

                names.push(DOC.wlan.channel);
                values.push(data2.channel);

                names.push(DOC.wlan.txPower);
                values.push(FormatUtil.formatField(data2.txpower, "dBm"));

                wirelessHtml = Page.createTable(DOC.title.wlan2g, names, values, names.length, 2).replace("<td>", "<td style=\"width:32%;\">");
            }
            $('#wlan_info').html(wirelessHtml);
            Page.setStripeTable("#wlan_info");
			}
			});

        }

        function loadWlan5gPage() {
            var data = {"mode":"Master","accessPoint":"","essid":"","wirelessMac":"","ssidBroadcast":"","encKey":"","wpa":"","wpaKeyMgmt":"","wpaPairwise":"","frequency":"","txPower":""};
            data.message ="WLAN未开启";
            var wlan5gHtml = "";
            if (data.mode.trim() == "NULL") {
                wlan5gHtml = Page.createTable(DOC.title.wlan5g + data.message, [], [], 0, 0);
            } else {
                var names = [];
                var values = [];

                names.push(DOC.wlan.currentMode);
                values.push(DOC.wlan.ApMode);

                names.push(DOC.wlan.wifi);
                if(CheckUtil.checkMac(data.accessPoint.trim()))
                    values.push(DOC.status.opened);
                else
                    values.push(DOC.status.closed);

                names.push(DOC.wlan.ssid);
                values.push(FormatUtil.formatField(data.essid.trim()));

                names.push(DOC.net.mac);
                values.push(FormatUtil.formatField(data.wirelessMac.trim()));

                names.push(DOC.wlan.ssidBroadcast);
                if(data.ssidBroadcast.trim() == "1"){
                    values.push(DOC.status.closed);
                } else {
                    values.push(DOC.status.opened);
                }

                names.push(DOC.wlan.secMode);
                values.push(FormatUtil.formatField(getWlanSecMode(data.encKey.trim(), data.wpa.trim(), data.wpaKeyMgmt.trim(), data.wpaPairwise.trim())));

                names.push(DOC.wlan.channel);
                values.push(FormatUtil.formatField(ConvertUtil.frequencyToChannel(data.frequency.trim()) + " / " + data.frequency.trim() + "GHz"));

                names.push(DOC.wlan.txPower);
                values.push(FormatUtil.formatField(data.txPower.trim(), "dBm"));

                wlan5gHtml = Page.createTable(DOC.title.wlan5g, names, values, names.length, 2).replace("<td>", "<td style=\"width:32%;\">");
            }
            $('#wlan_5g_info').html(wlan5gHtml);
            Page.setStripeTable("#wlan_5g_info");

        }

        loop();

        $('#net_info').click(function(e){
            if(e.target.id == "net_connect"){
                if(!AlertUtil.confirm(prompt.item1)){
                    return false;
                }

                Page.postJSON({
                    json:{
                        cmd: RequestCmd.NET_CONNECT
                    },
                    success: function(){

                    },
                    complete: function(){
                        count = 2;
                        Page.connectStatus = true;
                        $('#connectPrompt').html(prompt.item2);
                    }
                });
            } else if(e.target.id == "net_disconnect"){
                if(!AlertUtil.confirm(prompt.item3)){
                    return false;
                }
                Page.postJSON({
                    json:{
                        cmd: RequestCmd.NET_DISCONNECT
                    },
                    success: function(){

                    },
                    complete: function(){
                        count = 2;
                        Page.connectStatus = false;
                        $('#connectPrompt').html(prompt.item4);
                    }
                });
            }
        });
    });
</script>

<div class="detail_box">
    <div id="run_info"></div>
    <div id="net_info"></div>
    <div id="sim_info"></div>
    <div id="wan_info"></div>
    <div id="lan_info"></div>
    <div id="wlan_info"></div>
    <div id="wlan_5g_info"></div>
</div>